{% extends "base.html" %}
{% block content %}
{% if download %}
  <iframe src="{{ download }}" style="display:none" aria-hidden="true"></iframe>
{% endif %}

<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: var(--space-6); margin-bottom: var(--space-6);">
  <div class="card" style="border-left: 4px solid var(--teal-500); background: linear-gradient(135deg, #FFFFFF 0%, var(--teal-50) 100%); position: relative; overflow: hidden;">
    <div style="position: absolute; top: -50%; right: -50%; width: 200px; height: 200px; background: radial-gradient(circle, rgba(20, 184, 166, 0.1) 0%, transparent 70%); border-radius: 50%;"></div>
    <div class="card-body" style="padding: var(--space-6); position: relative; z-index: 1;">
      <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: var(--space-3);">
        <div style="width: 56px; height: 56px; background: linear-gradient(135deg, var(--teal-500), var(--teal-700)); border-radius: var(--radius-xl); display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(20, 184, 166, 0.3);">
          <svg style="width: 28px; height: 28px; color: white;" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
          </svg>
        </div>
        <span class="badge badge-teal" style="font-size: var(--text-sm); padding: 6px 14px;">üìÖ {{ year }}</span>
      </div>
      <div class="stats-value" style="font-size: var(--text-4xl); color: var(--teal-700); margin-bottom: var(--space-2);">{{ stats.total_annexes }}</div>
      <div class="stats-label" style="color: var(--text-secondary);">T·ªïng s·ªë ph·ª• l·ª•c</div>
    </div>
  </div>

  <div class="card" style="border-left: 4px solid var(--secondary-500); background: linear-gradient(135deg, #FFFFFF 0%, var(--secondary-50) 100%); position: relative; overflow: hidden;">
    <div style="position: absolute; top: -50%; right: -50%; width: 200px; height: 200px; background: radial-gradient(circle, rgba(34, 197, 94, 0.1) 0%, transparent 70%); border-radius: 50%;"></div>
    <div class="card-body" style="padding: var(--space-6); position: relative; z-index: 1;">
      <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: var(--space-3);">
        <div style="width: 56px; height: 56px; background: linear-gradient(135deg, var(--secondary-500), var(--secondary-700)); border-radius: var(--radius-xl); display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);">
          <svg style="width: 28px; height: 28px; color: white;" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
        </div>
        <span class="badge badge-green" style="font-size: var(--text-sm); padding: 6px 14px;">üí∞ VNƒê</span>
      </div>
      <div class="stats-value" style="font-size: var(--text-3xl); color: var(--secondary-700); margin-bottom: var(--space-2);">{{ "{:,}".format(stats.total_value).replace(",", ".") }}</div>
      <div class="stats-label" style="color: var(--text-secondary);">T·ªïng gi√° tr·ªã ph·ª• l·ª•c</div>
    </div>
  </div>

  <div class="card" style="border-left: 4px solid var(--primary-500); background: linear-gradient(135deg, #FFFFFF 0%, var(--primary-50) 100%); position: relative; overflow: hidden;">
    <div style="position: absolute; top: -50%; right: -50%; width: 200px; height: 200px; background: radial-gradient(circle, rgba(59, 130, 246, 0.1) 0%, transparent 70%); border-radius: 50%;"></div>
    <div class="card-body" style="padding: var(--space-6); position: relative; z-index: 1;">
      <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: var(--space-3);">
        <div style="width: 56px; height: 56px; background: linear-gradient(135deg, var(--primary-500), var(--primary-700)); border-radius: var(--radius-xl); display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);">
          <svg style="width: 28px; height: 28px; color: white;" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
          </svg>
        </div>
        <span class="badge badge-blue" style="font-size: var(--text-sm); padding: 6px 14px;">üìä Th·ªëng k√™</span>
      </div>
      <div class="stats-value" style="font-size: var(--text-4xl); color: var(--primary-700); margin-bottom: var(--space-2);">{{ stats.unique_contracts }}</div>
      <div class="stats-label" style="color: var(--text-secondary);">H·ª£p ƒë·ªìng c√≥ ph·ª• l·ª•c</div>
      {% if stats.most_annexes_contract %}
      <div style="margin-top: var(--space-4); padding-top: var(--space-3); border-top: 1px solid var(--border);">
        <div style="font-size: var(--text-sm); color: var(--text-secondary);">Nhi·ªÅu PL nh·∫•t:</div>
        <div style="font-size: var(--text-sm); color: var(--primary-700); font-weight: var(--font-semibold); margin-top: var(--space-1);">
          {{ stats.most_annexes_contract[:20] }}... ({{ stats.most_annexes_count }} PL)
        </div>
      </div>
      {% endif %}
    </div>
  </div>
</div>

<div class="card">
  <div class="card-header" style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: var(--space-4); border-left: 4px solid var(--teal-500);">
    <div>
      <h1 class="card-title" style="color: var(--teal-800); display: flex; align-items: center; gap: var(--space-3);">
        <svg style="width: 28px; height: 28px; color: var(--teal-600);" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
        </svg>
        Danh s√°ch ph·ª• l·ª•c
      </h1>
      <p style="font-size: var(--text-sm); color: var(--text-secondary); margin-top: var(--space-2);">
        üìé Qu·∫£n l√Ω v√† theo d√µi t·∫•t c·∫£ ph·ª• l·ª•c theo nƒÉm
      </p>
    </div>
    <form style="display: flex; gap: var(--space-2); align-items: center;" method="get" action="/annexes">
      <div class="form-group" style="margin: 0;">
        <input
          name="year"
          value="{{ year }}"
          class="form-input"
          placeholder="NƒÉm"
          style="width: 120px; border: 2px solid var(--teal-300);"
        />
      </div>
      <button class="btn btn-info" type="submit">
        <svg style="width: 16px; height: 16px;" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
        </svg>
        L·ªçc
      </button>
    </form>
  </div>

  <div class="card-body">
    <div style="margin-bottom: var(--space-4); position: relative;">
      <svg style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); width: 20px; height: 20px; color: var(--teal-500); pointer-events: none;" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
      </svg>
      <input
        type="text"
        placeholder="üîç T√¨m ki·∫øm theo s·ªë Hƒê, s·ªë PL..."
        class="form-input"
        data-table-search="annexes-table"
        style="max-width: 500px; padding-left: var(--space-10); border: 2px solid var(--teal-200); background: linear-gradient(135deg, white 0%, var(--teal-50) 100%);"
      />
    </div>

    <div class="table-wrapper" data-enhanced-table="annexes-table">
      <table class="table">
        <thead>
          <tr>
            <th data-sort="text">
              <div style="display: flex; align-items: center; gap: var(--space-2);">
                <svg style="width: 16px; height: 16px; color: var(--primary-600);" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 20l4-16m2 16l4-16M6 9h14M4 15h14" />
                </svg>
                S·ªë h·ª£p ƒë·ªìng
              </div>
            </th>
            <th data-sort="text">
              <div style="display: flex; align-items: center; gap: var(--space-2);">
                <svg style="width: 16px; height: 16px; color: var(--teal-600);" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
                S·ªë ph·ª• l·ª•c
              </div>
            </th>
            <th data-sort="text">
              <div style="display: flex; align-items: center; gap: var(--space-2);">
                <svg style="width: 16px; height: 16px; color: var(--purple-600);" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                </svg>
                ƒê∆°n v·ªã (Hƒê g·ªëc)
              </div>
            </th>
            <th data-sort="date">
              <div style="display: flex; align-items: center; gap: var(--space-2);">
                <svg style="width: 16px; height: 16px; color: var(--info-600);" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                </svg>
                Ng√†y k√Ω PL
              </div>
            </th>
            <th data-sort="number">
              <div style="display: flex; align-items: center; gap: var(--space-2);">
                <svg style="width: 16px; height: 16px; color: var(--secondary-600);" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                Gi√° tr·ªã
              </div>
            </th>
            <th>Thao t√°c</th>
          </tr>
        </thead>
        <tbody>
          {% for r in rows %}
            <tr>
              <td><strong style="color: var(--primary-700);">{{ r.contract_no }}</strong></td>
              <td>
                {% if r.annex_no %}
                  <span class="badge badge-teal">PL {{ r.annex_no }}</span>
                {% else %}
                  <span style="color: var(--text-tertiary);">-</span>
                {% endif %}
              </td>
              <td>
                {% if r.parent_contract %}
                  <div style="display: flex; flex-direction: column; gap: var(--space-1);">
                    <span style="font-weight: var(--font-medium);">{{ r.parent_contract.don_vi_ten[:30] }}{% if r.parent_contract.don_vi_ten|length > 30 %}...{% endif %}</span>
                    {% if r.parent_contract.kenh_ten %}
                      <span style="font-size: var(--text-xs); color: var(--text-tertiary);">üì∫ {{ r.parent_contract.kenh_ten[:20] }}</span>
                    {% endif %}
                  </div>
                {% else %}
                  <span style="color: var(--text-tertiary);">-</span>
                {% endif %}
              </td>
              <td><span style="color: var(--text-secondary); font-size: var(--text-sm);">{{ r.ngay_ky_phu_luc or r.ngay_lap_hop_dong or '-' }}</span></td>
              <td>
                {% if r.so_tien_nhuan_but_text %}
                  <span style="color: var(--secondary-700); font-weight: var(--font-semibold);">{{ r.so_tien_nhuan_but_text }}</span>
                  <span style="color: var(--text-tertiary); font-size: var(--text-xs);"> VNƒê</span>
                {% else %}
                  <span style="color: var(--text-tertiary);">-</span>
                {% endif %}
              </td>
              <td>
                <div style="display: flex; gap: var(--space-2); flex-wrap: wrap;">
                  {% if r.download_url %}
                    <a href="{{ r.download_url }}" class="btn btn-sm btn-success" title="T·∫£i xu·ªëng">
                      <svg class="icon" style="width: 14px; height: 14px;" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                      </svg>
                    </a>
                  {% endif %}
                  <button class="btn btn-sm btn-danger" onclick="deleteAnnex('{{ year }}', '{{ r.contract_no }}', '{{ r.annex_no }}')" title="X√≥a ph·ª• l·ª•c">
                    <svg class="icon" style="width: 14px; height: 14px;" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                  </button>
                </div>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>

      {% if rows|length == 0 %}
        <div class="empty-state">
          <svg class="empty-state-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
          </svg>
          <div class="empty-state-title">Ch∆∞a c√≥ ph·ª• l·ª•c</div>
          <div class="empty-state-description">Ch∆∞a c√≥ d·ªØ li·ªáu cho nƒÉm {{ year }}</div>
        </div>
      {% endif %}

      <div class="table-pagination" data-pagination-for="annexes-table"></div>
    </div>
  </div>

  <div class="card-footer" style="background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--teal-50) 100%);">
    <a href="/annexes/new" class="btn btn-primary">
      <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
      </svg>
      T·∫°o ph·ª• l·ª•c m·ªõi
    </a>
  </div>
</div>

<style>
.btn-danger {
  background: var(--danger, #ef4444);
  color: white;
}

.btn-danger:hover {
  background: #dc2626;
}
</style>

<script>
function deleteAnnex(year, contractNo, annexNo) {
  if (!confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ph·ª• l·ª•c ${annexNo}?\n\nThao t√°c n√†y s·∫Ω x√≥a:\n- Ph·ª• l·ª•c kh·ªèi danh s√°ch\n- File Word ƒë√£ t·∫°o\n- File Excel danh m·ª•c\n\nH√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!`)) {
    return;
  }

  fetch(`/annexes/${year}/${contractNo}/${annexNo}/delete`, { method: 'POST' })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        showToast(data.message || 'ƒê√£ x√≥a ph·ª• l·ª•c', 'success');
        setTimeout(() => location.reload(), 1000);
      } else {
        showToast(data.error || 'X√≥a th·∫•t b·∫°i', 'error');
      }
    })
    .catch(err => {
      showToast('L·ªói: ' + err.message, 'error');
    });
}
</script>
{% endblock %}
