{% extends "base.html" %}

{% block title %}Tạo tài liệu - Hệ thống Quản lý Hợp đồng{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">Tạo tài liệu mới</h1>
    <p class="page-description">Tạo hợp đồng hoặc phụ lục hợp đồng mới</p>
</div>

<div class="card">
    <div class="card-header">
        <div class="btn-group">
            <button type="button" class="btn btn-primary" id="btn-contract" onclick="switchDocType('contract')">
                <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                </svg>
                Hợp đồng
            </button>
            <button type="button" class="btn btn-outline" id="btn-annex" onclick="switchDocType('annex')">
                <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                </svg>
                Phụ lục
            </button>
        </div>
    </div>

    <div class="card-body">
        <form id="document-form" method="POST" action="/documents">
            <input type="hidden" name="doc_type" id="doc_type" value="{{ doc_type or 'contract' }}">

            <div id="contract-fields" style="display: {{ 'block' if doc_type == 'contract' or not doc_type else 'none' }}">
                <div class="form-group">
                    <label class="form-label form-label-required" for="ngay_lap_hop_dong">Ngày lập hợp đồng</label>
                    <input type="date" class="form-input" id="ngay_lap_hop_dong" name="ngay_lap_hop_dong" value="{{ today }}" required>
                </div>

                <div class="form-group">
                    <label class="form-label form-label-required" for="so_hop_dong_4">Số hợp đồng (4 chữ số)</label>
                    <input type="text" class="form-input" id="so_hop_dong_4" name="so_hop_dong_4" placeholder="0001" pattern="\d{4}" maxlength="4" required>
                    <div class="form-help">Nhập 4 chữ số, ví dụ: 0001, 0002, ...</div>
                </div>
            </div>

            <div id="annex-fields" style="display: {{ 'block' if doc_type == 'annex' else 'none' }}">
                <div class="form-group">
                    <label class="form-label form-label-required" for="contract_no">Chọn hợp đồng gốc</label>
                    <select class="form-select" id="contract_no" name="contract_no" onchange="loadContractPreview()">
                        <option value="">-- Chọn hợp đồng --</option>
                        {% for contract in contracts %}
                        <option value="{{ contract.contract_no }}" {% if selected_contract_no == contract.contract_no %}selected{% endif %}>
                            {{ contract.contract_no }} - {{ contract.don_vi_ten or 'Chưa có tên' }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label" for="annex_no">Số phụ lục</label>
                    <input type="text" class="form-input" id="annex_no" name="annex_no" placeholder="01">
                    <div class="form-help">Để trống nếu không cần đánh số</div>
                </div>

                <div class="form-group">
                    <label class="form-label form-label-required" for="ngay_ky_phu_luc">Ngày ký phụ lục</label>
                    <input type="date" class="form-input" id="ngay_ky_phu_luc" name="ngay_ky_phu_luc" value="{{ today }}">
                </div>

                <input type="hidden" id="ngay_ky_hop_dong" name="ngay_ky_hop_dong" value="{{ preview.ngay_lap_hop_dong or '' }}">
            </div>

            <div class="divider"></div>

            <h3 class="card-title" style="margin-bottom: 1.5rem;">Thông tin đơn vị</h3>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label form-label-required" for="don_vi_ten">Tên đơn vị</label>
                    <input type="text" class="form-input" id="don_vi_ten" name="don_vi_ten" value="{{ preview.don_vi_ten or '' }}" required>
                </div>

                <div class="form-group">
                    <label class="form-label" for="don_vi_mst">Mã số thuế</label>
                    <input type="text" class="form-input" id="don_vi_mst" name="don_vi_mst" value="{{ preview.don_vi_mst or '' }}">
                </div>
            </div>

            <div class="form-group">
                <label class="form-label" for="don_vi_dia_chi">Địa chỉ</label>
                <input type="text" class="form-input" id="don_vi_dia_chi" name="don_vi_dia_chi" value="{{ preview.don_vi_dia_chi or '' }}">
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label" for="don_vi_nguoi_dai_dien">Người đại diện</label>
                    <input type="text" class="form-input" id="don_vi_nguoi_dai_dien" name="don_vi_nguoi_dai_dien" value="{{ preview.don_vi_nguoi_dai_dien or '' }}">
                </div>

                <div class="form-group">
                    <label class="form-label" for="don_vi_chuc_vu">Chức vụ</label>
                    <input type="text" class="form-input" id="don_vi_chuc_vu" name="don_vi_chuc_vu" value="{{ preview.don_vi_chuc_vu or 'Giám đốc' }}">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label" for="don_vi_dien_thoai">Điện thoại</label>
                    <input type="text" class="form-input" id="don_vi_dien_thoai" name="don_vi_dien_thoai" value="{{ preview.don_vi_dien_thoai or '' }}" placeholder="0901234567">
                </div>

                <div class="form-group">
                    <label class="form-label" for="don_vi_email">Email</label>
                    <input type="email" class="form-input" id="don_vi_email" name="don_vi_email" value="{{ preview.don_vi_email or '' }}" placeholder="email@example.com">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label" for="so_CCCD">Số CCCD</label>
                    <input type="text" class="form-input" id="so_CCCD" name="so_CCCD" placeholder="001234567890">
                </div>

                <div class="form-group">
                    <label class="form-label" for="ngay_cap_CCCD">Ngày cấp CCCD</label>
                    <input type="text" class="form-input" id="ngay_cap_CCCD" name="ngay_cap_CCCD" placeholder="dd/mm/yyyy">
                </div>
            </div>

            <div class="divider"></div>

            <h3 class="card-title" style="margin-bottom: 1.5rem;">Thông tin kênh</h3>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label" for="kenh_ten">Tên kênh</label>
                    <input type="text" class="form-input" id="kenh_ten" name="kenh_ten" value="{{ preview.kenh_ten or '' }}">
                </div>

                <div class="form-group">
                    <label class="form-label" for="kenh_id">ID kênh (UC...)</label>
                    <input type="text" class="form-input" id="kenh_id" name="kenh_id" value="{{ preview.kenh_id or '' }}" placeholder="UCxxxxxxxxxx">
                </div>
            </div>

            <div class="form-group">
                <label class="form-label" for="linh_vuc">Lĩnh vực</label>
                <input type="text" class="form-input" id="linh_vuc" name="linh_vuc" value="Sao chép trực tuyến">
            </div>

            <div class="form-group">
                <label class="form-label" for="nguoi_thuc_hien_email">Email người thực hiện</label>
                <input type="email" class="form-input" id="nguoi_thuc_hien_email" name="nguoi_thuc_hien_email" placeholder="nguoithuchien@example.com">
            </div>

            <div class="divider"></div>

            <h3 class="card-title" style="margin-bottom: 1.5rem;">Thông tin thanh toán</h3>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label" for="so_tien_chua_GTGT">Số tiền chưa VAT (VNĐ)</label>
                    <input type="text" class="form-input" id="so_tien_chua_GTGT" name="so_tien_chua_GTGT" placeholder="15,600,000">
                </div>

                <div class="form-group">
                    <label class="form-label" for="thue_percent">Thuế GTGT (%)</label>
                    <input type="text" class="form-input" id="thue_percent" name="thue_percent" value="10">
                </div>
            </div>

            <div class="btn-group" style="margin-top: 2rem;">
                <button type="submit" class="btn btn-primary btn-lg">
                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                    </svg>
                    Tạo tài liệu
                </button>
                <a href="/contracts" class="btn btn-secondary btn-lg">
                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                    Hủy
                </a>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const docType = "{{ doc_type or 'contract' }}";

function switchDocType(type) {
    document.getElementById('doc_type').value = type;

    const contractBtn = document.getElementById('btn-contract');
    const annexBtn = document.getElementById('btn-annex');
    const contractFields = document.getElementById('contract-fields');
    const annexFields = document.getElementById('annex-fields');

    if (type === 'contract') {
        contractBtn.className = 'btn btn-primary';
        annexBtn.className = 'btn btn-outline';
        contractFields.style.display = 'block';
        annexFields.style.display = 'none';

        document.getElementById('ngay_lap_hop_dong').setAttribute('required', '');
        document.getElementById('so_hop_dong_4').setAttribute('required', '');
        document.getElementById('contract_no').removeAttribute('required');
        document.getElementById('ngay_ky_phu_luc').removeAttribute('required');
    } else {
        contractBtn.className = 'btn btn-outline';
        annexBtn.className = 'btn btn-primary';
        contractFields.style.display = 'none';
        annexFields.style.display = 'block';

        document.getElementById('ngay_lap_hop_dong').removeAttribute('required');
        document.getElementById('so_hop_dong_4').removeAttribute('required');
        document.getElementById('contract_no').setAttribute('required', '');
        document.getElementById('ngay_ky_phu_luc').setAttribute('required', '');
    }
}

function loadContractPreview() {
    const contractNo = document.getElementById('contract_no').value;
    if (!contractNo) return;

    window.location.href = `/documents/new?doc_type=annex&contract_no=${contractNo}`;
}

switchDocType(docType);
</script>
{% endblock %}
